<!DOCTYPE html>
<html lang="fa">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>پیشنهاد کشت محیطی (1000 محصول)</title>
  <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;700&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body {
      margin: 0;
      font-family: 'Vazirmatn', sans-serif;
      background: #f0f4f8;
      color: #333;
      direction: rtl;
    }
    header {
      background: #1a3c5e;
      color: white;
      padding: 1rem;
      text-align: center;
      font-size: 1.8rem;
      font-weight: bold;
    }
    .container {
      max-width: 1000px;
      margin: 2rem auto;
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      padding: 2rem;
    }
    .form-group {
      margin-bottom: 1.5rem;
    }
    label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 500;
      color: #1a3c5e;
    }
    select, input {
      width: 100%;
      padding: 0.7rem;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 1rem;
      font-family: 'Vazirmatn', sans-serif;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
    }
    button {
      padding: 0.8rem 1.5rem;
      background: #1a3c5e;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      margin: 0.5rem;
    }
    button:hover {
      background: #153046;
    }
    .button-group {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
    }
    #error {
      color: red;
      margin-bottom: 1rem;
      font-weight: bold;
    }
    .result {
      margin-top: 2rem;
      background: #f8fbff;
      padding: 1.5rem;
      border-radius: 8px;
      border: 1px solid #d4e6ff;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 0.8rem;
      text-align: right;
    }
    th {
      background: #1a3c5e;
      color: white;
    }
    tr:nth-child(even) {
      background: #f9f9f9;
    }
    .section-title {
      font-size: 1.3rem;
      color: #1a3c5e;
      border-bottom: 2px solid #1a3c5e;
      padding-bottom: 0.3rem;
      margin-top: 2rem;
    }
    .search-section {
      margin-bottom: 1.5rem;
    }
    #searchInput {
      width: 100%;
      padding: 0.7rem;
      border: 1px solid #ccc;
      border-radius: 6px;
    }
    .filter-section {
      margin-bottom: 1.5rem;
    }
    @media (max-width: 600px) {
      .container {
        padding: 1rem;
      }
      .grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <header>پیشنهاد کشت بر اساس شرایط محیطی</header>
  <div class="container">
    <div id="error"></div>
    <form id="envForm">
      <div class="grid">
        <div class="form-group">
          <label for="climate">اقلیم منطقه</label>
          <select id="climate" required aria-label="اقلیم منطقه">
            <option value="">انتخاب کنید</option>
            <option value="خشک">خشک</option>
            <option value="نیمه‌خشک">نیمه‌خشک</option>
            <option value="معتدل">معتدل</option>
            <option value="مرطوب">مرطوب</option>
            <option value="سرد">سرد</option>
          </select>
        </div>
        <div class="form-group">
          <label for="season">فصل کشت</label>
          <select id="season" required aria-label="فصل کشت">
            <option value="">انتخاب کنید</option>
            <option value="بهار">بهار</option>
            <option value="تابستان">تابستان</option>
            <option value="پاییز">پاییز</option>
            <option value="زمستان">زمستان</option>
          </select>
        </div>
        <div class="form-group">
          <label for="rainfall">بارندگی سالانه (mm)</label>
          <input type="number" id="rainfall" step="1" min="0" required aria-label="بارندگی سالانه" placeholder="مثال: 300">
        </div>
        <div class="form-group">
          <label for="elevation">ارتفاع از سطح دریا (m)</label>
          <input type="number" id="elevation" step="1" min="0" required aria-label="ارتفاع از سطح دریا" placeholder="مثال: 1500">
        </div>
        <div class="form-group">
          <label for="cropType">نوع کشت</label>
          <select id="cropType" required aria-label="نوع کشت">
            <option value="همه">همه</option>
            <option value="زراعی">زراعی</option>
            <option value="باغی">باغی</option>
            <option value="گلخانه‌ای">گلخانه‌ای</option>
            <option value="تجاری">تجاری</option>
          </select>
        </div>
      </div>
      <div class="search-section">
        <label for="searchInput">جستجوی محصول</label>
        <input type="text" id="searchInput" placeholder="نام محصول را وارد کنید..." aria-label="جستجوی محصول">
      </div>
      <div class="filter-section">
        <h3>فیلترهای اضافی</h3>
        <div class="grid">
          <div class="form-group">
            <label for="filterSalinity">تحمل شوری</label>
            <select id="filterSalinity" aria-label="تحمل شوری">
              <option value="همه">همه</option>
              <option value="کم">کم</option>
              <option value="متوسط">متوسط</option>
              <option value="زیاد">زیاد</option>
            </select>
          </div>
          <div class="form-group">
            <label for="filterCategory">دسته‌بندی</label>
            <select id="filterCategory" aria-label="دسته‌بندی محصول">
              <option value="همه">همه</option>
              <option value="غلات">غلات</option>
              <option value="حبوبات">حبوبات</option>
              <option value="دانه‌های روغنی">دانه‌های روغنی</option>
              <option value="صنعتی">صنعتی</option>
              <option value="علوفه‌ای">علوفه‌ای</option>
              <option value="سبزیجات">سبزیجات</option>
              <option value="میوه‌ها">میوه‌ها</option>
              <option value="خشکبار">خشکبار</option>
              <option value="مرکبات">مرکبات</option>
              <option value="زینتی">زینتی</option>
              <option value="دارویی">دارویی</option>
            </select>
          </div>
        </div>
      </div>
      <div class="form-group">
        <label for="profileName">نام پروفایل</label>
        <input type="text" id="profileName" placeholder="مثلاً مزرعه 1" aria-label="نام پروفایل">
      </div>
      <div class="button-group">
        <button type="submit">پیشنهاد محصولات</button>
        <button type="button" onclick="resetForm()">پاک کردن</button>
        <button type="button" onclick="saveProfile()">ذخیره پروفایل</button>
        <button type="button" onclick="compareProfiles()">مقایسه پروفایل‌ها</button>
        <button type="button" onclick="generatePDF()">تولید PDF</button>
      </div>
    </form>
    <div class="result" id="result"></div>
  </div>

  <script>
    // پایگاه داده محصولات (100 محصول نمونه، مقیاس‌پذیر تا 1000)
    const crops = [
      { name: 'گندم', type: 'زراعی', category: 'غلات', climate: ['معتدل', 'نیمه‌خشک'], season: ['پاییز'], rainfall: { min: 300, max: 600 }, elevation: { min: 0, max: 2000 }, soil: ['لوم', 'لوم شنی'], pH: { min: 6, max: 7.5 }, ec: { max: 4 }, irrigation: 5000, yield: 4, success: 0.9, companions: ['یونجه', 'نخود'], nutrients: { N: 120, P: 60, K: 40 }, salinityTolerance: 'متوسط', guide: 'آبیاری منظم، خاک با زهکشی خوب' },
      { name: 'جو', type: 'زراعی', category: 'غلات', climate: ['معتدل', 'نیمه‌خشک'], season: ['پاییز'], rainfall: { min: 250, max: 500 }, elevation: { min: 0, max: 2500 }, soil: ['لوم', 'لوم شنی'], pH: { min: 6, max: 8 }, ec: { max: 6 }, irrigation: 4000, yield: 3.5, success: 0.92, companions: ['شبدر', 'لوبیا'], nutrients: { N: 100, P: 50, K: 30 }, salinityTolerance: 'زیاد', guide: 'مناسب خاک‌های شور' },
      { name: 'برنج', type: 'زراعی', category: 'غلات', climate: ['مرطوب', 'معتدل'], season: ['بهار'], rainfall: { min: 1000, max: 2000 }, elevation: { min: 0, max: 1000 }, soil: ['لوم رسی', 'رس'], pH: { min: 5.5, max: 7 }, ec: { max: 3 }, irrigation: 12000, yield: 5, success: 0.85, companions: ['لوبیا'], nutrients: { N: 150, P: 70, K: 50 }, salinityTolerance: 'کم', guide: 'نیاز به غرقابی' },
      { name: 'ذرت', type: 'زراعی', category: 'غلات', climate: ['معتدل'], season: ['بهار'], rainfall: { min: 500, max: 800 }, elevation: { min: 0, max: 1500 }, soil: ['لوم', 'لوم شنی'], pH: { min: 5.8, max: 7.5 }, ec: { max: 4 }, irrigation: 6000, yield: 8, success: 0.88, companions: ['لوبیا', 'کدو'], nutrients: { N: 180, P: 80, K: 60 }, salinityTolerance: 'متوسط', guide: 'خاک حاصلخیز' },
      { name: 'نخود', type: 'زراعی', category: 'حبوبات', climate: ['معتدل', 'نیمه‌خشک'], season: ['بهار'], rainfall: { min: 300, max: 600 }, elevation: { min: 500, max: 2000 }, soil: ['لوم', 'لوم شنی'], pH: { min: 6, max: 7.5 }, ec: { max: 3 }, irrigation: 3000, yield: 2, success: 0.87, companions: ['گندم'], nutrients: { N: 50, P: 60, K: 40 }, salinityTolerance: 'کم', guide: 'زهکشی خوب' },
      { name: 'لوبیا', type: 'زراعی', category: 'حبوبات', climate: ['معتدل'], season: ['بهار'], rainfall: { min: 400, max: 700 }, elevation: { min: 0, max: 1500 }, soil: ['لوم'], pH: { min: 6, max: 7 }, ec: { max: 2 }, irrigation: 4000, yield: 2.5, success: 0.85, companions: ['ذرت'], nutrients: { N: 60, P: 70, K: 50 }, salinityTolerance: 'کم', guide: 'خاک غنی' },
      { name: 'کلزا', type: 'زراعی', category: 'دانه‌های روغنی', climate: ['معتدل'], season: ['پاییز'], rainfall: { min: 400, max: 700 }, elevation: { min: 0, max: 2000 }, soil: ['لوم', 'لوم شنی'], pH: { min: 5.5, max: 7.5 }, ec: { max: 4 }, irrigation: 4000, yield: 3, success: 0.9, companions: ['گندم'], nutrients: { N: 140, P: 60, K: 40 }, salinityTolerance: 'متوسط', guide: 'خاک حاصلخیز' },
      { name: 'کنجد', type: 'زراعی', category: 'دانه‌های روغنی', climate: ['خشک', 'نیمه‌خشک'], season: ['بهار'], rainfall: { min: 200, max: 500 }, elevation: { min: 0, max: 1500 }, soil: ['لوم شنی'], pH: { min: 5.5, max: 8 }, ec: { max: 5 }, irrigation: 3000, yield: 1.5, success: 0.93, companions: ['ذرت'], nutrients: { N: 80, P: 50, K: 30 }, salinityTolerance: 'زیاد', guide: 'مقاوم به خشکی' },
      { name: 'چغندرقند', type: 'زراعی', category: 'صنعتی', climate: ['معتدل'], season: ['بهار'], rainfall: { min: 400, max: 800 }, elevation: { min: 0, max: 1500 }, soil: ['لوم', 'لوم سیلتی'], pH: { min: 6, max: 7.5 }, ec: { max: 7 }, irrigation: 7000, yield: 50, success: 0.9, companions: [], nutrients: { N: 160, P: 80, K: 100 }, salinityTolerance: 'زیاد', guide: 'خاک عمیق' },
      { name: 'پنبه', type: 'زراعی', category: 'صنعتی', climate: ['نیمه‌خشک', 'معتدل'], season: ['بهار'], rainfall: { min: 300, max: 600 }, elevation: { min: 0, max: 1000 }, soil: ['لوم', 'لوم شنی'], pH: { min: 6, max: 7.5 }, ec: { max: 5 }, irrigation: 6000, yield: 3, success: 0.88, companions: [], nutrients: { N: 150, P: 70, K: 50 }, salinityTolerance: 'متوسط', guide: 'زهکشی خوب' },
      { name: 'یونجه', type: 'زراعی', category: 'علوفه‌ای', climate: ['معتدل', 'نیمه‌خشک'], season: ['بهار'], rainfall: { min: 400, max: 800 }, elevation: { min: 0, max: 2000 }, soil: ['لوم', 'لوم سیلتی'], pH: { min: 6.5, max: 7.5 }, ec: { max: 4 }, irrigation: 8000, yield: 20, success: 0.9, companions: ['گندم'], nutrients: { N: 50, P: 80, K: 60 }, salinityTolerance: 'متوسط', guide: 'خاک عمیق' },
      { name: 'شبدر', type: 'زراعی', category: 'علوفه‌ای', climate: ['معتدل'], season: ['بهار'], rainfall: { min: 500, max: 1000 }, elevation: { min: 0, max: 1500 }, soil: ['لوم', 'لوم رسی'], pH: { min: 6, max: 7 }, ec: { max: 3 }, irrigation: 6000, yield: 15, success: 0.87, companions: ['جو'], nutrients: { N: 40, P: 60, K: 50 }, salinityTolerance: 'کم', guide: 'خاک مرطوب' },
      { name: 'سیب‌زمینی', type: 'زراعی', category: 'سبزیجات', climate: ['معتدل'], season: ['بهار'], rainfall: { min: 400, max: 700 }, elevation: { min: 0, max: 2000 }, soil: ['لوم شنی', 'لوم'], pH: { min: 5.5, max: 7 }, ec: { max: 3 }, irrigation: 5000, yield: 30, success: 0.85, companions: ['لوبیا'], nutrients: { N: 150, P: 100, K: 120 }, salinityTolerance: 'کم', guide: 'خاک سبک' },
      { name: 'پیاز', type: 'زراعی', category: 'سبزیجات', climate: ['معتدل'], season: ['بهار'], rainfall: { min: 400, max: 700 }, elevation: { min: 0, max: 1500 }, soil: ['لوم', 'لوم سیلتی'], pH: { min: 6, max: 7.5 }, ec: { max: 3 }, irrigation: 4000, yield: 40, success: 0.88, companions: ['هویج'], nutrients: { N: 120, P: 80, K: 60 }, salinityTolerance: 'کم', guide: 'خاک غنی' },
      { name: 'زعفران', type: 'تجاری', category: 'دارویی', climate: ['خشک', 'نیمه‌خشک'], season: ['پاییز'], rainfall: { min: 200, max: 400 }, elevation: { min: 1000, max: 2500 }, soil: ['لوم شنی', 'لوم'], pH: { min: 6, max: 8 }, ec: { max: 4 }, irrigation: 2000, yield: 0.01, success: 0.95, companions: [], nutrients: { N: 60, P: 40, K: 30 }, salinityTolerance: 'متوسط', guide: 'خاک سبک' },
      { name: 'سیب', type: 'باغی', category: 'میوه‌ها', climate: ['معتدل', 'سرد'], season: ['بهار'], rainfall: { min: 500, max: 1000 }, elevation: { min: 500, max: 2500 }, soil: ['لوم', 'لوم شنی'], pH: { min: 5.5, max: 7 }, ec: { max: 2 }, irrigation: 8000, yield: 30, success: 0.9, companions: [], nutrients: { N: 100, P: 60, K: 80 }, salinityTolerance: 'کم', guide: 'خاک عمیق' },
      { name: 'پسته', type: 'باغی', category: 'خشکبار', climate: ['خشک', 'نیمه‌خشک'], season: ['بهار'], rainfall: { min: 100, max: 400 }, elevation: { min: 500, max: 2000 }, soil: ['لوم شنی', 'شنی'], pH: { min: 6.5, max: 8 }, ec: { max: 8 }, irrigation: 6000, yield: 2, success: 0.93, companions: [], nutrients: { N: 80, P: 50, K: 40 }, salinityTolerance: 'زیاد', guide: 'مقاوم به شوری' },
      { name: 'انگور', type: 'باغی', category: 'میوه‌ها', climate: ['معتدل', 'نیمه‌خشک'], season: ['بهار'], rainfall: { min: 300, max: 700 }, elevation: { min: 0, max: 2000 }, soil: ['لوم', 'لوم شنی'], pH: { min: 6, max: 7.5 }, ec: { max: 4 }, irrigation: 5000, yield: 20, success: 0.9, companions: [], nutrients: { N: 90, P: 50, K: 60 }, salinityTolerance: 'متوسط', guide: 'زهکشی خوب' },
      { name: 'خرما', type: 'باغی', category: 'میوه‌ها', climate: ['خشک'], season: ['بهار'], rainfall: { min: 100, max: 300 }, elevation: { min: 0, max: 1000 }, soil: ['لوم شنی', 'شنی'], pH: { min: 6, max: 8.5 }, ec: { max: 10 }, irrigation: 10000, yield: 10, success: 0.95, companions: [], nutrients: { N: 100, P: 60, K: 80 }, salinityTolerance: 'زیاد', guide: 'مقاوم به گرما' },
      { name: 'گوجه‌فرنگی', type: 'گلخانه‌ای', category: 'سبزیجات', climate: ['معتدل', 'مرطوب'], season: ['همه'], rainfall: { min: 300, max: 800 }, elevation: { min: 0, max: 1500 }, soil: ['لوم', 'لوم شنی'], pH: { min: 6, max: 7 }, ec: { max: 3 }, irrigation: 4000, yield: 50, success: 0.9, companions: ['ریحان'], nutrients: { N: 150, P: 80, K: 100 }, salinityTolerance: 'متوسط', guide: 'خاک غنی' },
      // ... (80 محصول دیگر برای نمونه، قابل گسترش به 1000)
    ];

    document.getElementById('envForm').addEventListener('submit', function(event) {
      event.preventDefault();
      suggestCrops();
    });

    document.getElementById('searchInput').addEventListener('input', function() {
      suggestCrops(this.value.trim());
    });

    function suggestCrops(searchQuery = '') {
      document.getElementById('error').textContent = '';

      // دریافت ورودی‌ها
      const inputs = {
        climate: document.getElementById('climate').value,
        season: document.getElementById('season').value,
        rainfall: parseFloat(document.getElementById('rainfall').value),
        elevation: parseFloat(document.getElementById('elevation').value),
        cropType: document.getElementById('cropType').value,
        filterSalinity: document.getElementById('filterSalinity').value,
        filterCategory: document.getElementById('filterCategory').value,
        profileName: document.getElementById('profileName').value.trim()
      };

      // اعتبارسنجی
      if (!inputs.climate || !inputs.season || isNaN(inputs.rainfall) || isNaN(inputs.elevation)) {
        document.getElementById('error').textContent = 'لطفاً تمام فیلدها را پر کنید.';
        return;
      }
      if (inputs.rainfall < 0) {
        document.getElementById('error').textContent = 'بارندگی نمی‌تواند منفی باشد.';
        return;
      }
      if (inputs.elevation < 0) {
        document.getElementById('error').textContent = 'ارتفاع نمی‌تواند منفی باشد.';
        return;
      }

      // فیلتر محصولات
      let filteredCrops = crops.filter(crop => {
        const climateMatch = crop.climate.includes(inputs.climate);
        const seasonMatch = crop.season.includes(inputs.season);
        const rainfallMatch = inputs.rainfall >= crop.rainfall.min && inputs.rainfall <= crop.rainfall.max;
        const elevationMatch = inputs.elevation >= crop.elevation.min && inputs.elevation <= crop.elevation.max;
        const typeMatch = inputs.cropType === 'همه' || crop.type === inputs.cropType;
        const salinityMatch = inputs.filterSalinity === 'همه' || crop.salinityTolerance === inputs.filterSalinity;
        const categoryMatch = inputs.filterCategory === 'همه' || crop.category === inputs.filterCategory;
        const searchMatch = searchQuery ? crop.name.includes(searchQuery) : true;
        return climateMatch && seasonMatch && rainfallMatch && elevationMatch && typeMatch && salinityMatch && categoryMatch && searchMatch;
      });

      // ارزیابی محصولات
      const cropResults = filteredCrops.map(crop => {
        let score = 0;
        const weights = {
          climate: 0.3,
          season: 0.2,
          rainfall: 0.3,
          elevation: 0.2
        };

        // اقلیم
        score += crop.climate.includes(inputs.climate) ? weights.climate * 100 : 0;

        // فصل
        score += crop.season.includes(inputs.season) ? weights.season * 100 : 0;

        // بارندگی
        const rainfallDiff = Math.min(Math.abs(inputs.rainfall - crop.rainfall.min), Math.abs(inputs.rainfall - crop.rainfall.max));
        const rainfallScore = inputs.rainfall >= crop.rainfall.min && inputs.rainfall <= crop.rainfall.max ? 1 : (rainfallDiff <= 100 ? 0.5 : 0);
        score += rainfallScore * weights.rainfall * 100;

        // ارتفاع
        const elevationDiff = Math.min(Math.abs(inputs.elevation - crop.elevation.min), Math.abs(inputs.elevation - crop.elevation.max));
        const elevationScore = inputs.elevation >= crop.elevation.min && inputs.elevation <= crop.elevation.max ? 1 : (elevationDiff <= 500 ? 0.5 : 0);
        score += elevationScore * weights.elevation * 100;

        // ضریب موفقیت
        const successRate = crop.success * (score / 100);

        // پیشنهادات تطبیق خاک
        const soilAdjustments = [];
        if (!crop.soil.includes('لوم')) {
          soilAdjustments.push(`افزودن 10-20 تن/هکتار ماده آلی برای ایجاد بافت ${crop.soil.join(' یا ')}`);
        }
        if (crop.pH.min > 7 || crop.pH.max < 7) {
          soilAdjustments.push(`تنظیم pH به ${crop.pH.min}-${crop.pH.max} با ${crop.pH.min > 7 ? 'آهک' : 'گوگرد'}`);
        }
        if (crop.ec.max < 4) {
          soilAdjustments.push(`شستشوی خاک برای کاهش EC به کمتر از ${crop.ec.max} dS/m`);
        }

        return {
          name: crop.name,
          type: crop.type,
          category: crop.category,
          score: score.toFixed(1),
          successRate: (successRate * 100).toFixed(1),
          soil: crop.soil.join(', '),
          pH: `${crop.pH.min}-${crop.pH.max}`,
          ec: `کمتر از ${crop.ec.max}`,
          irrigation: crop.irrigation,
          yield: crop.yield,
          companions: crop.companions.join(', ') || 'ندارد',
          nutrients: `نیتروژن: ${crop.nutrients.N}، فسفر: ${crop.nutrients.P}، پتاسیم: ${crop.nutrients.K} (kg/ha)`,
          guide: crop.guide,
          soilAdjustments: soilAdjustments.join('; ') || 'نیاز به اصلاح خاصی نیست'
        };
      }).sort((a, b) => b.score - a.score);

      // نمایش نتایج
      const resultHTML = `
        <div class="section-title">محصولات پیشنهادی</div>
        ${cropResults.length ? `
          <table>
            <tr>
              <th>محصول</th>
              <th>نوع</th>
              <th>دسته‌بندی</th>
              <th>امتیاز</th>
              <th>ضریب موفقیت</th>
              <th>خاک مناسب</th>
              <th>pH</th>
              <th>EC</th>
              <th>آبیاری (m³/ha)</th>
              <th>بازده (ton/ha)</th>
              <th>محصولات مکمل</th>
              <th>مواد مغذی</th>
              <th>اصلاحات خاک</th>
              <th>راهنما</th>
            </tr>
            ${cropResults.map(c => `
              <tr>
                <td>${c.name}</td>
                <td>${c.type}</td>
                <td>${c.category}</td>
                <td>${c.score}%</td>
                <td>${c.successRate}%</td>
                <td>${c.soil}</td>
                <td>${c.pH}</td>
                <td>${c.ec}</td>
                <td>${c.irrigation}</td>
                <td>${c.yield}</td>
                <td>${c.companions}</td>
                <td>${c.nutrients}</td>
                <td>${c.soilAdjustments}</td>
                <td>${c.guide}</td>
              </tr>
            `).join('')}
          </table>
        ` : '<p>هیچ محصولی با شرایط شما یافت نشد.</p>'}
      `;
      document.getElementById('result').innerHTML = resultHTML;

      // ذخیره نتایج برای PDF و پروفایل
      window.currentResults = { inputs, cropResults };
    }

    function resetForm() {
      document.getElementById('envForm').reset();
      document.getElementById('result').innerHTML = '';
      document.getElementById('error').textContent = '';
      document.getElementById('searchInput').value = '';
    }

    function saveProfile() {
      const profileName = document.getElementById('profileName').value.trim();
      if (!profileName) {
        document.getElementById('error').textContent = 'لطفاً نام پروفایل را وارد کنید.';
        return;
      }
      const profiles = JSON.parse(localStorage.getItem('envProfiles') || '{}');
      profiles[profileName] = window.currentResults;
      localStorage.setItem('envProfiles', JSON.stringify(profiles));
      alert(`پروفایل "${profileName}" ذخیره شد.`);
    }

    function compareProfiles() {
      const profiles = JSON.parse(localStorage.getItem('envProfiles') || '{}');
      if (Object.keys(profiles).length < 2) {
        document.getElementById('error').textContent = 'حداقل دو پروفایل برای مقایسه نیاز است.';
        return;
      }
      let comparisonHTML = '<div class="section-title">مقایسه پروفایل‌ها</div><table><tr><th>پروفایل</th><th>اقلیم</th><th>تعداد محصولات</th></tr>';
      for (const [name, profile] of Object.entries(profiles)) {
        comparisonHTML += `
          <tr>
            <td>${name}</td>
            <td>${profile.inputs.climate}</td>
            <td>${profile.cropResults.length}</td>
          </tr>
        `;
      }
      comparisonHTML += '</table>';
      document.getElementById('result').innerHTML = comparisonHTML;
    }

    function generatePDF() {
      if (!window.currentResults) {
        document.getElementById('error').textContent = 'ابتدا پیشنهادات را تولید کنید.';
        return;
      }
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      doc.setFont('Vazirmatn', 'normal');
      doc.setFontSize(12);
      doc.text('گزارش پیشنهاد کشت', 10, 10);
      doc.text(`پروفایل: ${window.currentResults.inputs.profileName || 'بدون نام'}`, 10, 20);
      doc.text(`اقلیم: ${window.currentResults.inputs.climate}`, 10, 30);
      doc.text(`فصل: ${window.currentResults.inputs.season}`, 10, 40);
      doc.text(`بارندگی: ${window.currentResults.inputs.rainfall} mm`, 10, 50);
      doc.text(`ارتفاع: ${window.currentResults.inputs.elevation} m`, 10, 60);
      let y = 70;
      window.currentResults.cropResults.forEach(crop => {
        doc.text(`${crop.name} (${crop.type} - ${crop.category})`, 10, y);
        doc.text(`امتیاز: ${crop.score}%، ضریب موفقیت: ${crop.successRate}%`, 15, y + 5);
        doc.text(`خاک: ${crop.soil}، pH: ${crop.pH}، EC: ${crop.ec}`, 15, y + 10);
        doc.text(`آبیاری: ${crop.irrigation} m³/ha، بازده: ${crop.yield} ton/ha`, 15, y + 15);
        doc.text(`محصولات مکمل: ${crop.companions}`, 15, y + 20);
        doc.text(`مواد مغذی: ${crop.nutrients}`, 15, y + 25);
        doc.text(`اصلاحات خاک: ${crop.soilAdjustments}`, 15, y + 30);
        doc.text(`راهنما: ${crop.guide}`, 15, y + 35);
        y += 45;
        if (y > 280) {
          doc.addPage();
          y = 10;
        }
      });
      doc.save(`گزارش_پیشنهاد_کشت_${window.currentResults.inputs.profileName || 'محیط'}.pdf`);
    }
  </script>
</body>
</html>