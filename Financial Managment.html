<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>مدیریت مالی هوشمند کشاورزی</title>
    <style>
        /* تنظیمات عمومی */
        :root {
            --primary: #4CAF50;
            --primary-light: #66BB6A;
            --background: #F5F5F5;
            --card: #FFFFFF;
            --text: #1A1A1A;
            --text-secondary: #4A4A4A;
            --shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            --border: #E0E0E0;
            --dark-bg: #121212;
            --dark-card: #1E1E1E;
            --dark-text: #E0E0E0;
            --dark-border: #333;
        }

        body {
            font-family: 'Vazir', -apple-system, sans-serif;
            margin: 0;
            padding: 20px;
            background: var(--background);
            color: var(--text);
            transition: all 0.3s ease;
            line-height: 1.6;
        }

        body.dark-mode {
            background: var(--dark-bg);
            color: var(--dark-text);
        }

        body.dark-mode .container, body.dark-mode .dashboard, body.dark-mode .tabcontent {
            background: var(--dark-card);
            border-color: var(--dark-border);
        }

        body.dark-mode input, body.dark-mode select {
            background: #2C2C2C;
            color: var(--dark-text);
            border-color: var(--dark-border);
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: var(--card);
            padding: 30px;
            border-radius: 20px;
            box-shadow: var(--shadow);
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        h1 {
            text-align: center;
            font-size: 32px;
            font-weight: 700;
            color: var(--primary);
            margin: 0 0 20px;
        }

        .dashboard {
            background: linear-gradient(135deg, #e8f5e9, #f1f8e9);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            text-align: center;
            box-shadow: var(--shadow);
        }

        .dashboard p {
            margin: 5px 0;
            font-size: 16px;
            color: var(--text-secondary);
        }

        .tab {
            display: flex;
            background: var(--card);
            border-radius: 15px 15px 0 0;
            overflow: hidden;
            margin-bottom: 10px;
            box-shadow: var(--shadow);
        }

        .tab button {
            flex: 1;
            padding: 15px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            color: var(--text-secondary);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .tab button:hover, .tab button.active {
            background: var(--primary);
            color: #FFFFFF;
        }

        .tabcontent {
            padding: 25px;
            border: 1px solid var(--border);
            border-top: none;
            border-radius: 0 0 15px 15px;
            background: var(--card);
            animation: fadeIn 0.3s ease;
        }

        .form-group {
            margin-bottom: 20px;
            position: relative;
        }

        label {
            display: block;
            font-weight: 500;
            color: var(--text);
            margin-bottom: 8px;
        }

        select, input[type="text"], input[type="number"], input[type="date"], input[type="checkbox"] {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: 10px;
            font-size: 16px;
            background: var(--card);
            color: var(--text);
            transition: border-color 0.3s, box-shadow 0.3s;
        }

        select:focus, input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 5px rgba(76, 175, 80, 0.3);
            outline: none;
        }

        .tooltip {
            position: absolute;
            top: -30px;
            left: 10px;
            background: var(--primary);
            color: #FFFFFF;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
            display: none;
            z-index: 10;
        }

        .form-group:hover .tooltip {
            display: block;
        }

        button.submit-btn, button.report-btn {
            background: linear-gradient(90deg, var(--primary), var(--primary-light));
            color: #FFFFFF;
            padding: 14px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            width: 100%;
            transition: transform 0.2s, box-shadow 0.2s;
            margin-top: 10px;
        }

        button.submit-btn:hover, button.report-btn:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        #result, #history {
            margin-top: 20px;
            padding: 20px;
            border-radius: 10px;
            background: var(--card);
            border: 1px solid var(--border);
        }

        .history-item {
            padding: 15px;
            border-bottom: 1px solid var(--border);
            transition: background 0.2s;
        }

        .history-item:hover {
            background: #f1f8e9;
        }

        .loader {
            display: none;
            text-align: center;
            padding: 15px;
            color: var(--primary);
            font-weight: 500;
        }

        #chart-container {
            margin-top: 20px;
            padding: 20px;
            border-radius: 10px;
            background: var(--card);
        }

        .theme-toggle {
            position: fixed;
            top: 20px;
            left: 20px;
            background: var(--primary);
            color: #FFFFFF;
            border: none;
            padding: 10px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 18px;
            box-shadow: var(--shadow);
        }

        @media (max-width: 600px) {
            .container {
                padding: 15px;
            }
            h1 {
                font-size: 24px;
            }
            .tab button {
                font-size: 14px;
                padding: 10px;
            }
        }
    </style>
</head>
<body>
    <button class="theme-toggle" onclick="toggleDarkMode()">🌙</button>
    <div class="container">
        <h1>مدیریت مالی هوشمند کشاورزی</h1>
        <div class="dashboard">
            <h3>خلاصه وضعیت مالی</h3>
            <p id="dashboard-profit">سود/زیان: 0 ریال</p>
            <p id="dashboard-cashflow">جریان نقدی خالص: 0 ریال</p>
            <p id="dashboard-inventory">موجودی کل: 0</p>
        </div>
        <div class="tab">
            <button class="tablinks active" onclick="openTab(event, 'income')">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 2v20m10-10H2"/>
                </svg>
                درآمد
            </button>
            <button class="tablinks" onclick="openTab(event, 'expense')">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M22 12H2"/>
                </svg>
                هزینه
            </button>
            <button class="tablinks" onclick="openTab(event, 'inventory')">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M20 6H4v12h16V6z"/>
                </svg>
                موجودی
            </button>
            <button class="tablinks" onclick="openTab(event, 'debt')">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 2v4m0 12v4m-6-10h12"/>
                </svg>
                وام
            </button>
            <button class="tablinks" onclick="openTab(event, 'reports')">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M9 17v-6m6 6v-9m-6 9H5a2 2 0 01-2-2V5a2 2 0 012-2h14a2 2 0 012 2v10a2 2 0 01-2 2h-4"/>
                </svg>
                گزارش‌ها
            </button>
            <button class="tablinks" onclick="openTab(event, 'calendar')">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M19 4H5a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2V6a2 2 0 00-2-2zM16 2v4M8 2v4M3 10h18"/>
                </svg>
                تقویم
            </button>
        </div>

        <!-- فرم درآمد -->
        <div id="income" class="tabcontent" style="display: block;">
            <div class="form-group">
                <label for="income-source">منبع درآمد (اجباری):</label>
                <span class="tooltip">منبع درآمد مثل فروش محصول یا یارانه</span>
                <select id="income-source" required>
                    <option value="">انتخاب کنید</option>
                    <option value="فروش گندم">فروش گندم</option>
                    <option value="فروش گوجه‌فرنگی">فروش گوجه‌فرنگی</option>
                    <option value="فروش زعفران">فروش زعفران</option>
                    <option value="فروش خیار">فروش خیار</option>
                    <option value="فروش پسته">فروش پسته</option>
                    <option value="فروش برنج">فروش برنج</option>
                    <option value="یارانه دولتی">یارانه دولتی</option>
                    <option value="سایر">سایر</option>
                </select>
            </div>
            <div class="form-group">
                <label for="income-product">محصول مرتبط (اختیاری):</label>
                <span class="tooltip">محصول مرتبط با درآمد</span>
                <select id="income-product">
                    <option value="">انتخاب کنید</option>
                    <option value="گندم">گندم</option>
                    <option value="گوجه‌فرنگی">گوجه‌فرنگی</option>
                    <option value="زعفران">زعفران</option>
                    <option value="خیار">خیار</option>
                    <option value="پسته">پسته</option>
                    <option value="برنج">برنج</option>
                </select>
            </div>
            <div class="form-group">
                <label for="income-amount">مبلغ (ریال، اجباری):</label>
                <span class="tooltip">مبلغ درآمد</span>
                <input type="number" id="income-amount" min="0" placeholder="مثال: 5000000" required>
            </div>
            <div class="form-group">
                <label for="income-date">تاریخ (اختیاری):</label>
                <span class="tooltip">تاریخ دریافت درآمد</span>
                <input type="date" id="income-date">
            </div>
            <div class="form-group">
                <label for="income-recurring">تکرارشونده؟ (اختیاری):</label>
                <span class="tooltip">درآمد ماهانه یا دوره‌ای</span>
                <input type="checkbox" id="income-recurring"> ماهانه
            </div>
            <div class="form-group">
                <label for="income-notes">یادداشت (اختیاری):</label>
                <span class="tooltip">توضیحات اضافی مثل خریدار</span>
                <input type="text" id="income-notes" placeholder="مثال: فروش به تعاونی">
            </div>
            <button class="submit-btn" onclick="submitIncome()">ثبت درآمد</button>
        </div>

        <!-- فرم هزینه -->
        <div id="expense" class="tabcontent">
            <div class="form-group">
                <label for="expense-type">نوع هزینه (اجباری):</label>
                <span class="tooltip">نوع هزینه مثل کود یا نیروی کار</span>
                <select id="expense-type" required>
                    <option value="">انتخاب کنید</option>
                    <option value="کود">کود</option>
                    <option value="سم">سم</option>
                    <option value="نیروی کار">نیروی کار</option>
                    <option value="ماشین‌آلات">ماشین‌آلات</option>
                    <option value="آبیاری">آبیاری</option>
                    <option value="مالیات">مالیات</option>
                    <option value="سایر">سایر</option>
                </select>
            </div>
            <div class="form-group">
                <label for="expense-product">محصول مرتبط (اختیاری):</label>
                <span class="tooltip">محصول مرتبط با هزینه</span>
                <select id="expense-product">
                    <option value="">انتخاب کنید</option>
                    <option value="گندم">گندم</option>
                    <option value="گوجه‌فرنگی">گوجه‌فرنگی</option>
                    <option value="زعفران">زعفران</option>
                    <option value="خیار">خیار</option>
                    <option value="پسته">پسته</option>
                    <option value="برنج">برنج</option>
                </select>
            </div>
            <div class="form-group">
                <label for="expense-amount">مبلغ (ریال، اجباری):</label>
                <span class="tooltip">مبلغ هزینه</span>
                <input type="number" id="expense-amount" min="0" placeholder="مثال: 2000000" required>
            </div>
            <div class="form-group">
                <label for="expense-date">تاریخ (اختیاری):</label>
                <span class="tooltip">تاریخ پرداخت هزینه</span>
                <input type="date" id="expense-date">
            </div>
            <div class="form-group">
                <label for="expense-recurring">تکرارشونده؟ (اختیاری):</label>
                <span class="tooltip">هزینه ماهانه یا دوره‌ای</span>
                <input type="checkbox" id="expense-recurring"> ماهانه
            </div>
            <div class="form-group">
                <label for="expense-notes">یادداشت (اختیاری):</label>
                <span class="tooltip">توضیحات اضافی مثل فروشنده</span>
                <input type="text" id="expense-notes" placeholder="مثال: خرید کود از شرکت X">
            </div>
            <button class="submit-btn" onclick="submitExpense()">ثبت هزینه</button>
        </div>

        <!-- فرم موجودی -->
        <div id="inventory" class="tabcontent">
            <div class="form-group">
                <label for="inventory-type">نوع موجودی (اجباری):</label>
                <span class="tooltip">نوع موجودی مثل محصول یا تجهیزات</span>
                <select id="inventory-type" required>
                    <option value="">انتخاب کنید</option>
                    <option value="گندم">گندم</option>
                    <option value="گوجه‌فرنگی">گوجه‌فرنگی</option>
                    <option value="زعفران">زعفران</option>
                    <option value="کود">کود</option>
                    <option value="ماشین‌آلات">ماشین‌آلات</option>
                </select>
            </div>
            <div class="form-group">
                <label for="inventory-quantity">مقدار (اجباری):</label>
                <span class="tooltip">مقدار موجودی (مثل کیلوگرم)</span>
                <input type="number" id="inventory-quantity" min="0" placeholder="مثال: 1000" required>
            </div>
            <div class="form-group">
                <label for="inventory-unit">واحد (اختیاری):</label>
                <span class="tooltip">واحد مثل کیلوگرم یا عدد</span>
                <input type="text" id="inventory-unit" placeholder="مثال: کیلوگرم">
            </div>
            <div class="form-group">
                <label for="inventory-notes">یادداشت (اختیاری):</label>
                <span class="tooltip">توضیحات مثل محل ذخیره</span>
                <input type="text" id="inventory-notes" placeholder="مثال: انبار شماره 1">
            </div>
            <button class="submit-btn" onclick="submitInventory()">ثبت موجودی</button>
        </div>

        <!-- فرم وام -->
        <div id="debt" class="tabcontent">
            <div class="form-group">
                <label for="debt-amount">مبلغ وام (ریال، اجباری):</label>
                <span class="tooltip">مبلغ وام دریافتی</span>
                <input type="number" id="debt-amount" min="0" placeholder="مثال: 10000000" required>
            </div>
            <div class="form-group">
                <label for="debt-interest">نرخ بهره (%) (اختیاری):</label>
                <span class="tooltip">نرخ بهره سالیانه</span>
                <input type="number" id="debt-interest" min="0" step="0.1" placeholder="مثال: 5">
            </div>
            <div class="form-group">
                <label for="debt-due">سررسید (اختیاری):</label>
                <span class="tooltip">تاریخ بازپرداخت</span>
                <input type="date" id="debt-due">
            </div>
            <div class="form-group">
                <label for="debt-notes">یادداشت (اختیاری):</label>
                <span class="tooltip">توضیحات مثل نام بانک</span>
                <input type="text" id="debt-notes" placeholder="مثال: وام از بانک کشاورزی">
            </div>
            <button class="submit-btn" onclick="submitDebt()">ثبت وام</button>
        </div>

        <!-- گزارش‌ها -->
        <div id="reports" class="tabcontent">
            <h2>گزارش‌های مالی</h2>
            <button class="report-btn" onclick="generateBalanceSheet()">ترازنامه</button>
            <button class="report-btn" onclick="generateIncomeStatement()">صورت سود و زیان</button>
            <button class="report-btn" onclick="generateCashFlow()">صورت جریان نقدی</button>
            <button class="report-btn" onclick="generateTaxReport()">گزارش مالیاتی</button>
            <button class="report-btn" onclick="generateProductProfit()">سودآوری محصولات</button>
            <button class="report-btn" onclick="predictNextThreeMonths()">پیش‌بینی 3 ماه</button>
            <button class="report-btn" onclick="exportReport()">صادر کردن گزارش</button>
            <div id="result"></div>
            <div id="chart-container"></div>
        </div>

        <!-- تقویم مالی -->
        <div id="calendar" class="tabcontent">
            <h2>تقویم مالی</h2>
            <div id="calendar-content"></div>
        </div>

        <div class="loader" id="loader">در حال پردازش...</div>
        <div id="history">
            <h2>تاریخچه تراکنش‌ها</h2>
            <div class="form-group">
                <label for="history-filter">فیلتر:</label>
                <select id="history-filter" onchange="displayHistory()">
                    <option value="all">همه</option>
                    <option value="income">درآمد</option>
                    <option value="expense">هزینه</option>
                    <option value="inventory">موجودی</option>
                    <option value="debt">وام</option>
                </select>
            </div>
            <div id="history-list"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // داده‌های مالی
        const financialData = {
            income: [],
            expense: [],
            inventory: [],
            debt: [],
            balanceSheet: { assets: 0, liabilities: 0, equity: 0 }
        };

        // تغییر تم
        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            localStorage.setItem('theme', document.body.classList.contains('dark-mode') ? 'dark' : 'light');
        }

        // مدیریت تب‌ها
        function openTab(evt, tabName) {
            document.querySelectorAll('.tabcontent').forEach(el => el.style.display = 'none');
            document.querySelectorAll('.tablinks').forEach(el => el.classList.remove('active'));
            document.getElementById(tabName).style.display = 'block';
            evt.currentTarget.classList.add('active');
            if (tabName === 'calendar') displayCalendar();
        }

        // ثبت درآمد
        function submitIncome() {
            const loader = document.getElementById('loader');
            loader.style.display = 'block';
            setTimeout(() => {
                loader.style.display = 'none';
                processIncome();
            }, 500);
        }

        function processIncome() {
            const source = document.getElementById('income-source').value;
            const product = document.getElementById('income-product').value;
            const amount = document.getElementById('income-amount').value;
            const date = document.getElementById('income-date').value || new Date().toLocaleDateString('fa-IR');
            const recurring = document.getElementById('income-recurring').checked;
            const notes = document.getElementById('income-notes').value;
            const resultDiv = document.getElementById('result');

            if (!source || !amount) {
                resultDiv.innerHTML = '<p style="color: red;">لطفاً منبع و مبلغ درآمد را وارد کنید.</p>';
                return;
            }

            const income = { source, product: product || 'نامشخص', amount: parseFloat(amount), date, recurring, notes };
            financialData.income.push(income);
            financialData.balanceSheet.assets += parseFloat(amount);
            financialData.balanceSheet.equity += parseFloat(amount);
            saveData();
            updateDashboard();
            resultDiv.innerHTML = `<p style="color: green;">درآمد ${source} با مبلغ ${amount} ریال ثبت شد.</p>`;
            displayHistory();
        }

        // ثبت هزینه
        function submitExpense() {
            const loader = document.getElementById('loader');
            loader.style.display = 'block';
            setTimeout(() => {
                loader.style.display = 'none';
                processExpense();
            }, 500);
        }

        function processExpense() {
            const type = document.getElementById('expense-type').value;
            const product = document.getElementById('expense-product').value;
            const amount = document.getElementById('expense-amount').value;
            const date = document.getElementById('expense-date').value || new Date().toLocaleDateString('fa-IR');
            const recurring = document.getElementById('expense-recurring').checked;
            const notes = document.getElementById('expense-notes').value;
            const resultDiv = document.getElementById('result');

            if (!type || !amount) {
                resultDiv.innerHTML = '<p style="color: red;">لطفاً نوع و مبلغ هزینه را وارد کنید.</p>';
                return;
            }

            const expense = { type, product: product || 'نامشخص', amount: parseFloat(amount), date, recurring, notes };
            financialData.expense.push(expense);
            financialData.balanceSheet.assets -= parseFloat(amount);
            financialData.balanceSheet.equity -= parseFloat(amount);
            saveData();
            updateDashboard();
            resultDiv.innerHTML = `<p style="color: green;">هزینه ${type} با مبلغ ${amount} ریال ثبت شد.</p>`;
            displayHistory();
        }

        // ثبت موجودی
        function submitInventory() {
            const loader = document.getElementById('loader');
            loader.style.display = 'block';
            setTimeout(() => {
                loader.style.display = 'none';
                processInventory();
            }, 500);
        }

        function processInventory() {
            const type = document.getElementById('inventory-type').value;
            const quantity = document.getElementById('inventory-quantity').value;
            const unit = document.getElementById('inventory-unit').value || 'نامشخص';
            const notes = document.getElementById('inventory-notes').value;
            const resultDiv = document.getElementById('result');

            if (!type || !quantity) {
                resultDiv.innerHTML = '<p style="color: red;">لطفاً نوع و مقدار موجودی را وارد کنید.</p>';
                return;
            }

            const inventory = { type, quantity: parseFloat(quantity), unit, notes, date: new Date().toLocaleDateString('fa-IR') };
            financialData.inventory.push(inventory);
            saveData();
            updateDashboard();
            resultDiv.innerHTML = `<p style="color: green;">موجودی ${type} با مقدار ${quantity} ${unit} ثبت شد.</p>`;
            if (quantity < 10) {
                resultDiv.innerHTML += `<p style="color: red;">هشدار: موجودی ${type} کم است!</p>`;
            }
            displayHistory();
        }

        // ثبت وام
        function submitDebt() {
            const loader = document.getElementById('loader');
            loader.style.display = 'block';
            setTimeout(() => {
                loader.style.display = 'none';
                processDebt();
            }, 500);
        }

        function processDebt() {
            const amount = document.getElementById('debt-amount').value;
            const interest = document.getElementById('debt-interest').value || 0;
            const due = document.getElementById('debt-due').value || 'نامشخص';
            const notes = document.getElementById('debt-notes').value;
            const resultDiv = document.getElementById('result');

            if (!amount) {
                resultDiv.innerHTML = '<p style="color: red;">لطفاً مبلغ وام را وارد کنید.</p>';
                return;
            }

            const debt = { amount: parseFloat(amount), interest: parseFloat(interest), due, notes, date: new Date().toLocaleDateString('fa-IR') };
            financialData.debt.push(debt);
            financialData.balanceSheet.assets += parseFloat(amount);
            financialData.balanceSheet.liabilities += parseFloat(amount);
            saveData();
            updateDashboard();
            resultDiv.innerHTML = `<p style="color: green;">وام با مبلغ ${amount} ریال ثبت شد.</p>`;
            if (due && new Date(due) < new Date(new Date().setDate(new Date().getDate() + 7))) {
                resultDiv.innerHTML += `<p style="color: red;">هشدار: سررسید وام نزدیک است!</p>`;
            }
            displayHistory();
        }

        // ذخیره داده‌ها
        function saveData() {
            localStorage.setItem('financialData', JSON.stringify(financialData));
        }

        // به‌روزرسانی داشبورد
        function updateDashboard() {
            const totalIncome = financialData.income.reduce((sum, item) => sum + item.amount, 0);
            const totalExpense = financialData.expense.reduce((sum, item) => sum + item.amount, 0);
            const profit = totalIncome - totalExpense;
            const cashFlow = totalIncome - totalExpense;
            const totalInventory = financialData.inventory.reduce((sum, item) => sum + item.quantity, 0);
            document.getElementById('dashboard-profit').innerText = `سود/زیان: ${profit.toLocaleString('fa-IR')} ریال`;
            document.getElementById('dashboard-cashflow').innerText = `جریان نقدی خالص: ${cashFlow.toLocaleString('fa-IR')} ریال`;
            document.getElementById('dashboard-inventory').innerText = `موجودی کل: ${totalInventory.toLocaleString('fa-IR')}`;
            if (cashFlow < 0) {
                document.getElementById('dashboard-cashflow').style.color = 'red';
            } else {
                document.getElementById('dashboard-cashflow').style.color = 'green';
            }
        }

        // نمایش تاریخچه
        function displayHistory() {
            const filter = document.getElementById('history-filter').value;
            const historyList = document.getElementById('history-list');
            historyList.innerHTML = '';
            if (filter === 'all' || filter === 'income') {
                financialData.income.forEach(item => {
                    historyList.innerHTML += `
                        <div class="history-item">
                            <p><strong>نوع:</strong> درآمد - ${item.source}</p>
                            <p><strong>محصول:</strong> ${item.product}</p>
                            <p><strong>مبلغ:</strong> ${item.amount.toLocaleString('fa-IR')} ریال</p>
                            <p><strong>تاریخ:</strong> ${item.date}</p>
                            <p><strong>تکرارشونده:</strong> ${item.recurring ? 'بله' : 'خیر'}</p>
                            <p><strong>یادداشت:</strong> ${item.notes || 'نامشخص'}</p>
                        </div>
                    `;
                });
            }
            if (filter === 'all' || filter === 'expense') {
                financialData.expense.forEach(item => {
                    historyList.innerHTML += `
                        <div class="history-item">
                            <p><strong>نوع:</strong> هزینه - ${item.type}</p>
                            <p><strong>محصول:</strong> ${item.product}</p>
                            <p><strong>مبلغ:</strong> ${item.amount.toLocaleString('fa-IR')} ریال</p>
                            <p><strong>تاریخ:</strong> ${item.date}</p>
                            <p><strong>تکرارشونده:</strong> ${item.recurring ? 'بله' : 'خیر'}</p>
                            <p><strong>یادداشت:</strong> ${item.notes || 'نامشخص'}</p>
                        </div>
                    `;
                });
            }
            if (filter === 'all' || filter === 'inventory') {
                financialData.inventory.forEach(item => {
                    historyList.innerHTML += `
                        <div class="history-item">
                            <p><strong>نوع:</strong> موجودی - ${item.type}</p>
                            <p><strong>مقدار:</strong> ${item.quantity.toLocaleString('fa-IR')} ${item.unit}</p>
                            <p><strong>تاریخ:</strong> ${item.date}</p>
                            <p><strong>یادداشت:</strong> ${item.notes || 'نامشخص'}</p>
                        </div>
                    `;
                });
            }
            if (filter === 'all' || filter === 'debt') {
                financialData.debt.forEach(item => {
                    historyList.innerHTML += `
                        <div class="history-item">
                            <p><strong>نوع:</strong> وام</p>
                            <p><strong>مبلغ:</strong> ${item.amount.toLocaleString('fa-IR')} ریال</p>
                            <p><strong>نرخ بهره:</strong> ${item.interest}%</p>
                            <p><strong>سررسید:</strong> ${item.due}</p>
                            <p><strong>تاریخ:</strong> ${item.date}</p>
                            <p><strong>یادداشت:</strong> ${item.notes || 'نامشخص'}</p>
                        </div>
                    `;
                });
            }
        }

        // تولید ترازنامه
        function generateBalanceSheet() {
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = `
                <h3>ترازنامه</h3>
                <p><strong>دارایی‌ها:</strong> ${financialData.balanceSheet.assets.toLocaleString('fa-IR')} ریال</p>
                <p><strong>بدهی‌ها:</strong> ${financialData.balanceSheet.liabilities.toLocaleString('fa-IR')} ریال</p>
                <p><strong>حقوق صاحبان سهام:</strong> ${financialData.balanceSheet.equity.toLocaleString('fa-IR')} ریال</p>
            `;
            drawBalanceChart();
        }

        // تولید صورت سود و زیان
        function generateIncomeStatement() {
            const totalIncome = financialData.income.reduce((sum, item) => sum + item.amount, 0);
            const totalExpense = financialData.expense.reduce((sum, item) => sum + item.amount, 0);
            const profit = totalIncome - totalExpense;
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = `
                <h3>صورت سود و زیان</h3>
                <p><strong>کل درآمدها:</strong> ${totalIncome.toLocaleString('fa-IR')} ریال</p>
                <p><strong>کل هزینه‌ها:</strong> ${totalExpense.toLocaleString('fa-IR')} ریال</p>
                <p><strong>سود/زیان:</strong> ${profit.toLocaleString('fa-IR')} ریال</p>
            `;
            drawProfitChart(totalIncome, totalExpense, profit);
        }

        // تولید صورت جریان نقدی
        function generateCashFlow() {
            const totalIncome = financialData.income.reduce((sum, item) => sum + item.amount, 0);
            const totalExpense = financialData.expense.reduce((sum, item) => sum + item.amount, 0);
            const cashFlow = totalIncome - totalExpense;
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = `
                <h3>صورت جریان نقدی</h3>
                <p><strong>جریان نقدی ورودی:</strong> ${totalIncome.toLocaleString('fa-IR')} ریال</p>
                <p><strong>جریان نقدی خروجی:</strong> ${totalExpense.toLocaleString('fa-IR')} ریال</p>
                <p><strong>جریان نقدی خالص:</strong> ${cashFlow.toLocaleString('fa-IR')} ریال</p>
                ${cashFlow < 0 ? '<p style="color: red;">هشدار: جریان نقدی منفی است!</p>' : ''}
            `;
            drawCashFlowChart(totalIncome, totalExpense, cashFlow);
        }

        // تولید گزارش مالیاتی
        function generateTaxReport() {
            const taxableIncome = financialData.income.filter(item => item.source !== 'یارانه دولتی').reduce((sum, item) => sum + item.amount, 0);
            const deductibleExpenses = financialData.expense.filter(item => item.type !== 'مالیات').reduce((sum, item) => sum + item.amount, 0);
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = `
                <h3>گزارش مالیاتی</h3>
                <p><strong>درآمد مشمول مالیات:</strong> ${taxableIncome.toLocaleString('fa-IR')} ریال</p>
                <p><strong>هزینه‌های قابل کسر:</strong> ${deductibleExpenses.toLocaleString('fa-IR')} ریال</p>
                <p><strong>سود مشمول مالیات:</strong> ${(taxableIncome - deductibleExpenses).toLocaleString('fa-IR')} ریال</p>
                <p>توصیه: این گزارش را به اداره مالیات ارائه دهید.</p>
            `;
        }

        // تولید گزارش سودآوری محصولات
        function generateProductProfit() {
            const products = [...new Set([...financialData.income.map(i => i.product), ...financialData.expense.map(e => e.product)])].filter(p => p !== 'نامشخص');
            let resultHTML = '<h3>سودآوری محصولات</h3>';
            products.forEach(product => {
                const productIncome = financialData.income.filter(i => i.product === product).reduce((sum, i) => sum + i.amount, 0);
                const productExpense = financialData.expense.filter(e => e.product === product).reduce((sum, e) => sum + e.amount, 0);
                const profit = productIncome - productExpense;
                resultHTML += `
                    <p><strong>${product}:</strong></p>
                    <p>درآمد: ${productIncome.toLocaleString('fa-IR')} ریال</p>
                    <p>هزینه: ${productExpense.toLocaleString('fa-IR')} ریال</p>
                    <p>سود/زیان: ${profit.toLocaleString('fa-IR')} ریال</p>
                    ${profit < 0 ? '<p style="color: red;">هشدار: این محصول زیان‌ده است!</p>' : ''}
                `;
            });
            document.getElementById('result').innerHTML = resultHTML;
            drawProductProfitChart(products);
        }

        // پیش‌بینی 3 ماه آینده
        function predictNextThreeMonths() {
            const avgIncome = financialData.income.reduce((sum, item) => sum + item.amount, 0) / Math.max(1, financialData.income.length);
            const avgExpense = financialData.expense.reduce((sum, item) => sum + item.amount, 0) / Math.max(1, financialData.expense.length);
            const prediction = (avgIncome - avgExpense) * 3;
            document.getElementById('result').innerHTML = `
                <h3>پیش‌بینی 3 ماه آینده</h3>
                <p><strong>سود احتمالی:</strong> ${prediction.toLocaleString('fa-IR')} ریال</p>
                <p>بر اساس میانگین درآمدها و هزینه‌های فعلی</p>
            `;
        }

        // صادر کردن گزارش
        function exportReport() {
            const dataStr = JSON.stringify(financialData, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'financial_report.json';
            link.click();
            URL.revokeObjectURL(url);
            document.getElementById('result').innerHTML = '<p style="color: green;">گزارش با موفقیت صادر شد.</p>';
        }

        // نمایش تقویم مالی
        function displayCalendar() {
            const calendarContent = document.getElementById('calendar-content');
            let html = '<h3>رویدادهای مالی</h3>';
            financialData.debt.forEach(debt => {
                if (debt.due !== 'نامشخص') {
                    html += `<p>سررسید وام ${debt.amount.toLocaleString('fa-IR')} ریال: ${debt.due}</p>`;
                }
            });
            financialData.expense.forEach(expense => {
                if (expense.recurring) {
                    html += `<p>هزینه تکرارشونده ${expense.type} (${expense.amount.toLocaleString('fa-IR')} ریال): هر ماه</p>`;
                }
            });
            financialData.income.forEach(income => {
                if (income.recurring) {
                    html += `<p>درآمد تکرارشونده ${income.source} (${income.amount.toLocaleString('fa-IR')} ریال): هر ماه</p>`;
                }
            });
            calendarContent.innerHTML = html || '<p>هیچ رویداد مالی ثبت نشده است.</p>';
        }

        // نمودار ترازنامه
        function drawBalanceChart() {
            const chartContainer = document.getElementById('chart-container');
            chartContainer.innerHTML = '<canvas id="balanceChart"></canvas>';
            const ctx = document.getElementById('balanceChart').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['دارایی‌ها', 'بدهی‌ها', 'حقوق صاحبان سهام'],
                    datasets: [{
                        label: 'ترازنامه',
                        data: [
                            financialData.balanceSheet.assets,
                            financialData.balanceSheet.liabilities,
                            financialData.balanceSheet.equity
                        ],
                        backgroundColor: ['#4CAF50', '#FF5722', '#2196F3'],
                        borderColor: ['#388E3C', '#D32F2F', '#1976D2'],
                        borderWidth: 1
                    }]
                },
                options: {
                    scales: { y: { beginAtZero: true, title: { display: true, text: 'مبلغ (ریال)' } } },
                    plugins: { title: { display: true, text: 'ترازنامه مالی', font: { size: 18 } } }
                }
            });
        }

        // نمودار سود و زیان
        function drawProfitChart(totalIncome, totalExpense, profit) {
            const chartContainer = document.getElementById('chart-container');
            chartContainer.innerHTML = '<canvas id="profitChart"></canvas>';
            const ctx = document.getElementById('profitChart').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['درآمدها', 'هزینه‌ها', 'سود/زیان'],
                    datasets: [{
                        label: 'صورت سود و زیان',
                        data: [totalIncome, totalExpense, profit],
                        backgroundColor: ['#4CAF50', '#FF5722', profit >= 0 ? '#2196F3' : '#F44336'],
                        borderColor: ['#388E3C', '#D32F2F', profit >= 0 ? '#1976D2' : '#D32F2F'],
                        borderWidth: 1
                    }]
                },
                options: {
                    scales: { y: { beginAtZero: true, title: { display: true, text: 'مبلغ (ریال)' } } },
                    plugins: { title: { display: true, text: 'صورت سود و زیان', font: { size: 18 } } }
                }
            });
        }

        // نمودار جریان نقدی
        function drawCashFlowChart(totalIncome, totalExpense, cashFlow) {
            const chartContainer = document.getElementById('chart-container');
            chartContainer.innerHTML = '<canvas id="cashFlowChart"></canvas>';
            const ctx = document.getElementById('cashFlowChart').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['ورودی نقدی', 'خروجی نقدی', 'جریان نقدی خالص'],
                    datasets: [{
                        label: 'صورت جریان نقدی',
                        data: [totalIncome, totalExpense, cashFlow],
                        backgroundColor: ['#4CAF50', '#FF5722', cashFlow >= 0 ? '#2196F3' : '#F44336'],
                        borderColor: ['#388E3C', '#D32F2F', cashFlow >= 0 ? '#1976D2' : '#D32F2F'],
                        borderWidth: 1
                    }]
                },
                options: {
                    scales: { y: { beginAtZero: true, title: { display: true, text: 'مبلغ (ریال)' } } },
                    plugins: { title: { display: true, text: 'صورت جریان نقدی', font: { size: 18 } } }
                }
            });
        }

        // نمودار سودآوری محصولات
        function drawProductProfitChart(products) {
            const chartContainer = document.getElementById('chart-container');
            chartContainer.innerHTML = '<canvas id="productProfitChart"></canvas>';
            const ctx = document.getElementById('productProfitChart').getContext('2d');
            const datasets = products.map(product => {
                const profit = financialData.income.filter(i => i.product === product).reduce((sum, i) => sum + i.amount, 0) -
                              financialData.expense.filter(e => e.product === product).reduce((sum, e) => sum + e.amount, 0);
                return profit;
            });
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: products,
                    datasets: [{
                        label: 'سود/زیان محصولات',
                        data: datasets,
                        backgroundColor: datasets.map(p => p >= 0 ? '#4CAF50' : '#F44336'),
                        borderColor: datasets.map(p => p >= 0 ? '#388E3C' : '#D32F2F'),
                        borderWidth: 1
                    }]
                },
                options: {
                    scales: { y: { title: { display: true, text: 'سود/زیان (ریال)' } } },
                    plugins: { title: { display: true, text: 'سودآوری محصولات', font: { size: 18 } } }
                }
            });
        }

        // بارگذاری اولیه
        document.addEventListener('DOMContentLoaded', () => {
            const savedData = JSON.parse(localStorage.getItem('financialData'));
            if (savedData) {
                financialData.income = savedData.income || [];
                financialData.expense = savedData.expense || [];
                financialData.inventory = savedData.inventory || [];
                financialData.debt = savedData.debt || [];
                financialData.balanceSheet = savedData.balanceSheet || { assets: 0, liabilities: 0, equity: 0 };
            }
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') document.body.classList.add('dark-mode');
            updateDashboard();
            displayHistory();
            document.getElementsByClassName('tabcontent')[0].style.display = 'block';
        });
    </script>
</body>
</html>